import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';
import * as SecureStore from 'expo-secure-store';

const DEFAULT_LOCALE = 'pt';
const LANGUAGE_STORAGE_KEY = 'app_language';

const resources = {
  pt: {
    translation: {
      common: {
        ok: 'OK',
        cancel: 'Cancelar',
        back: 'Voltar',
        create: 'Criar',
        filter: 'Filtrar',
        logout: 'Sair',
      },
      home: {
        title: 'Início',
        tabLabel: 'Início',
        greetingMorning: 'Bom dia',
        greetingAfternoon: 'Boa tarde',
        greetingEvening: 'Boa noite',
        summary: 'Resumo',
        activeCounts: 'Em andamento',
        finishedCounts: 'Finalizadas',
        totalProducts: 'Produtos',
        completionRate: 'Conclusão',
        quickActions: 'Ações rápidas',
        newCount: 'Nova contagem',
        viewCounts: 'Ver contagens',
        recentActivity: 'Atividade recente',
        noRecentActivity: 'Nenhuma contagem recente.',
        startCounting: 'Comece criando uma nova contagem.',
        continueCount: 'Continuar',
        viewCount: 'Ver',
        count: 'Contagem',
        settings: 'Configurações',
        teamActivity: 'Contagem por usuário',
        activeCountsLabel_one: '{{count}} contagem',
        activeCountsLabel_other: '{{count}} contagens',
        productsLabel: '{{counted}}/{{total}} produtos',
      },
      auth: {
        login: 'Entrar',
        loginWithGoogle: 'Entrar com Google',
        selectUser: 'Selecione um perfil para entrar',
        roleAdmin: 'Administrador',
        roleManager: 'Gerente',
        roleEmployee: 'Funcionário',
      },
      counts: {
        title: 'Contagens',
        newCount: 'Abrir nova contagem',
        code: 'Código',
        stock: 'Estoque',
        startDate: 'Data de início',
        endDate: 'Data de finalização',
        status: 'Status',
        inProgress: 'em andamento',
        finished: 'finalizado',
        actions: 'Ações',
        continue: 'Continuar',
        verify: 'Conferir',
        delete: 'Excluir',
        deleteConfirmTitle: 'Excluir contagem',
        deleteConfirmMessage: 'Tem certeza que deseja excluir esta contagem? Esta ação não pode ser desfeita.',
        dateFrom: 'Data de',
        dateTo: 'Data até',
        allStocks: 'Todos os estoques',
        allStatuses: 'Todos',
        finalize: 'Finalizar contagem',
        finalizedSuccess: 'Contagem finalizada.',
        viewOnly: 'Contagem finalizada (somente leitura)',
        balance: 'Saldo',
        velocity: 'Velocidade (%/dia)',
        divergenceTitle: 'Divergência',
        divergenceMessage: 'Quantidade contada diferente do sistema. Deseja refazer a contagem?',
        keepCount: 'Não, registrar assim',
        refillCount: 'Sim, refazer',
        totalProducts: 'Produtos',
        productsCounted: 'Produtos contados',
        itemsCounted: 'Itens contados',
        countedAt: 'Data/hora da contagem',
        countedQtyLabel: 'Quantidade contada',
        pdvOfflineTitle: 'PDV offline',
        pdvOfflineMessage: 'Conecte o(s) PDV(s) vinculado(s) ao estoque antes de registrar.',
        transferPendingTitle: 'Transferência pendente',
        transferPendingMessage: 'Finalize as transferências pendentes deste produto antes de registrar.',
        staleBanner: '{{count}} contagem(ns) em andamento há mais de {{days}} dias',
        showFilters: 'Filtros',
        hideFilters: 'Ocultar filtros',
        emptyTitle: 'Nenhuma contagem encontrada',
        emptyMessage: 'Crie uma nova contagem para começar o inventário.',
        sectionInProgress: 'Em andamento',
        sectionFinished: 'Finalizadas',
        started: 'Iniciada',
        productsProgress: '{{counted}} de {{total}} produtos',
        allProductsCounted: '{{total}} produtos contados',
        complete: 'Completa',
        today: 'Hoje',
        daysAgo_one: 'Há {{count}} dia',
        daysAgo_other: 'Há {{count}} dias',
        durationDays_one: '{{count}} dia',
        durationDays_other: '{{count}} dias',
        velocityShort: '{{value}}%/dia',
        storeClosed: 'Fechada',
        storeOpen: 'Funcionando',
        countingBy: 'Contando: {{name}}',
        createdBy: 'Criada por {{name}}',
        finalizedBy: 'Finalizada por {{name}}',
        noPermission: 'Sem permissão para esta ação',
        deleteErrorTitle: 'Erro ao excluir',
        deleteErrorMessage: 'Não foi possível excluir a contagem.',
        finalizeConfirmMessage: 'Tem certeza que deseja finalizar esta contagem? Esta ação não pode ser desfeita.',
        finalizeErrorTitle: 'Erro ao finalizar',
        finalizeErrorMessage: 'Não foi possível finalizar a contagem.',
      },
      newCount: {
        title: 'Nova contagem',
        stockLabel: 'Estoque',
        structureLabel: 'Estrutura mercadológica',
        allCategories: 'Todas',
        selectedCount: '{{count}} selecionada(s)',
        valueToConsider: 'Valor a considerar',
        salesValue: 'Valor de venda',
        costValue: 'Valor de custo',
        storeModeLabel: 'Modalidade de contagem',
        storeModeClosed: 'Loja fechada',
        storeModeOpen: 'Loja funcionando',
        storeModeHelpTitle: 'Modalidade de contagem',
        storeModeHelpBody: 'Loja fechada: a contagem é realizada com a loja fechada, sem movimentação de estoque durante o processo. Garante maior precisão nos resultados.\n\nLoja funcionando: a contagem é realizada com a loja em operação. As vendas e entradas continuam ocorrendo normalmente, e o sistema considera os ajustes de movimentação durante a contagem.',
        createErrorTitle: 'Erro ao criar',
        createErrorMessage: 'Não foi possível criar a contagem.',
      },
      settings: {
        title: 'Configurações',
        language: 'Idioma',
        theme: 'Aparência',
        themeSystem: 'Sistema',
        themeLight: 'Claro',
        themeDark: 'Escuro',
        account: 'Conta',
        role: 'Perfil',
        countProductSort: 'Ordem da lista na contagem',
        sortByName: 'Nome',
        sortByCode: 'Código',
        sortByValue: 'Valor',
        blindCount: 'Contagem às cegas',
        blindCountDescription: 'Oculta a quantidade do sistema durante a contagem',
        yes: 'Sim',
        no: 'Não',
        noPermission: 'Sem permissão para alterar esta configuração',
        profile: 'Perfil',
        preferences: 'Preferências',
        counting: 'Contagem',
        version: 'Versão {{version}}',
      },
    },
  },
  en: {
    translation: {
      common: {
        ok: 'OK',
        cancel: 'Cancel',
        back: 'Back',
        create: 'Create',
        filter: 'Filter',
        logout: 'Log out',
      },
      home: {
        title: 'Home',
        tabLabel: 'Home',
        greetingMorning: 'Good morning',
        greetingAfternoon: 'Good afternoon',
        greetingEvening: 'Good evening',
        summary: 'Summary',
        activeCounts: 'Active',
        finishedCounts: 'Finished',
        totalProducts: 'Products',
        completionRate: 'Completion',
        quickActions: 'Quick actions',
        newCount: 'New count',
        viewCounts: 'View counts',
        recentActivity: 'Recent activity',
        noRecentActivity: 'No recent counts.',
        startCounting: 'Start by creating a new count.',
        continueCount: 'Continue',
        viewCount: 'View',
        count: 'Count',
        settings: 'Settings',
        teamActivity: 'Counting by user',
        activeCountsLabel_one: '{{count}} count',
        activeCountsLabel_other: '{{count}} counts',
        productsLabel: '{{counted}}/{{total}} products',
      },
      auth: {
        login: 'Log in',
        loginWithGoogle: 'Sign in with Google',
        selectUser: 'Select a profile to sign in',
        roleAdmin: 'Admin',
        roleManager: 'Manager',
        roleEmployee: 'Employee',
      },
      counts: {
        title: 'Counts',
        newCount: 'Open new count',
        code: 'Code',
        stock: 'Stock',
        startDate: 'Start date',
        endDate: 'End date',
        status: 'Status',
        inProgress: 'in progress',
        finished: 'finished',
        actions: 'Actions',
        continue: 'Continue',
        verify: 'Verify',
        delete: 'Delete',
        deleteConfirmTitle: 'Delete count',
        deleteConfirmMessage: 'Are you sure you want to delete this count? This action cannot be undone.',
        dateFrom: 'From date',
        dateTo: 'To date',
        allStocks: 'All stocks',
        allStatuses: 'All',
        finalize: 'Finalize count',
        finalizedSuccess: 'Count finalized.',
        viewOnly: 'Count finalized (read-only)',
        balance: 'Balance',
        velocity: 'Velocity (%/day)',
        divergenceTitle: 'Divergence',
        divergenceMessage: 'Counted quantity differs from system. Do you want to recount?',
        keepCount: 'No, register as is',
        refillCount: 'Yes, recount',
        totalProducts: 'Products',
        productsCounted: 'Products counted',
        itemsCounted: 'Items counted',
        countedAt: 'Count date/time',
        countedQtyLabel: 'Counted quantity',
        pdvOfflineTitle: 'PDV offline',
        pdvOfflineMessage: 'Connect the PDV(s) linked to this stock before registering.',
        transferPendingTitle: 'Pending transfer',
        transferPendingMessage: 'Complete pending transfers for this product before registering.',
        staleBanner: '{{count}} count(s) in progress for more than {{days}} days',
        showFilters: 'Filters',
        hideFilters: 'Hide filters',
        emptyTitle: 'No counts found',
        emptyMessage: 'Create a new count to start inventory.',
        sectionInProgress: 'In progress',
        sectionFinished: 'Finished',
        started: 'Started',
        productsProgress: '{{counted}} of {{total}} products',
        allProductsCounted: '{{total}} products counted',
        complete: 'Complete',
        today: 'Today',
        daysAgo_one: '{{count}} day ago',
        daysAgo_other: '{{count}} days ago',
        durationDays_one: '{{count}} day',
        durationDays_other: '{{count}} days',
        velocityShort: '{{value}}%/day',
        storeClosed: 'Closed',
        storeOpen: 'Open',
        countingBy: 'Counting: {{name}}',
        createdBy: 'Created by {{name}}',
        finalizedBy: 'Finalized by {{name}}',
        noPermission: 'No permission for this action',
        deleteErrorTitle: 'Delete error',
        deleteErrorMessage: 'Could not delete the count.',
        finalizeConfirmMessage: 'Are you sure you want to finalize this count? This action cannot be undone.',
        finalizeErrorTitle: 'Finalize error',
        finalizeErrorMessage: 'Could not finalize the count.',
      },
      newCount: {
        title: 'New count',
        stockLabel: 'Stock',
        structureLabel: 'Product structure (category)',
        allCategories: 'All',
        selectedCount: '{{count}} selected',
        valueToConsider: 'Value to consider',
        salesValue: 'Sales value',
        costValue: 'Cost value',
        storeModeLabel: 'Counting mode',
        storeModeClosed: 'Store closed',
        storeModeOpen: 'Store open',
        storeModeHelpTitle: 'Counting mode',
        storeModeHelpBody: 'Store closed: the count is performed while the store is closed, with no stock movements during the process. This ensures greater accuracy in results.\n\nStore open: the count is performed while the store is operating. Sales and entries continue normally, and the system accounts for stock movements during the count.',
        createErrorTitle: 'Create error',
        createErrorMessage: 'Could not create the count.',
      },
      settings: {
        title: 'Settings',
        language: 'Language',
        theme: 'Appearance',
        themeSystem: 'System',
        themeLight: 'Light',
        themeDark: 'Dark',
        account: 'Account',
        role: 'Role',
        countProductSort: 'Product list order in count',
        sortByName: 'Name',
        sortByCode: 'Code',
        sortByValue: 'Value',
        blindCount: 'Blind count',
        blindCountDescription: 'Hides system quantity during counting',
        yes: 'Yes',
        no: 'No',
        noPermission: 'No permission to change this setting',
        profile: 'Profile',
        preferences: 'Preferences',
        counting: 'Counting',
        version: 'Version {{version}}',
      },
    },
  },
};

/**
 * Initialize i18n with PT and EN. Default language is PT; user can switch to EN in Settings.
 */
export function initI18n(): void {
  i18n.use(initReactI18next).init({
    resources,
    lng: DEFAULT_LOCALE,
    fallbackLng: DEFAULT_LOCALE,
    supportedLngs: ['pt', 'en'],
    interpolation: { escapeValue: false },
  });
}

export type SupportedLng = 'pt' | 'en';

/**
 * Read persisted language preference. Call after init to apply user choice.
 */
export async function getStoredLanguage(): Promise<SupportedLng | null> {
  try {
    const value = await SecureStore.getItemAsync(LANGUAGE_STORAGE_KEY);
    if (value === 'pt' || value === 'en') return value;
  } catch {
    // ignore
  }
  return null;
}

/**
 * Persist language preference and change i18n language.
 */
export async function setStoredLanguage(lng: SupportedLng): Promise<void> {
  try {
    await SecureStore.setItemAsync(LANGUAGE_STORAGE_KEY, lng);
    await i18n.changeLanguage(lng);
  } catch {
    i18n.changeLanguage(lng);
  }
}

export default i18n;
