import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';
import * as SecureStore from 'expo-secure-store';

const DEFAULT_LOCALE = 'pt';
const LANGUAGE_STORAGE_KEY = 'app_language';

const resources = {
  pt: {
    translation: {
      common: {
        ok: 'OK',
        cancel: 'Cancelar',
        back: 'Voltar',
        create: 'Criar',
        filter: 'Filtrar',
        logout: 'Sair',
      },
      home: {
        title: 'Início',
        tabLabel: 'Início',
        greetingMorning: 'Bom dia',
        greetingAfternoon: 'Boa tarde',
        greetingEvening: 'Boa noite',
        summary: 'Resumo',
        activeCounts: 'Em andamento',
        finishedCounts: 'Finalizadas',
        totalProducts: 'Produtos',
        completionRate: 'Conclusão',
        quickActions: 'Ações rápidas',
        newCount: 'Nova contagem',
        viewCounts: 'Ver contagens',
        recentActivity: 'Atividade recente',
        noRecentActivity: 'Nenhuma contagem recente.',
        startCounting: 'Comece criando uma nova contagem.',
        continueCount: 'Continuar',
        viewCount: 'Ver',
        count: 'Contagem',
        settings: 'Configurações',
        teamActivity: 'Contagem por usuário',
        activeCountsLabel_one: '{{count}} contagem',
        activeCountsLabel_other: '{{count}} contagens',
        productsLabel: '{{counted}}/{{total}} produtos',
      },
      auth: {
        login: 'Entrar',
        loginWithGoogle: 'Entrar com Google',
        selectUser: 'Selecione um perfil para entrar',
        roleAdmin: 'Administrador',
        roleManager: 'Gerente',
        roleEmployee: 'Funcionário',
      },
      counts: {
        title: 'Contagens',
        newCount: 'Abrir nova contagem',
        code: 'Código',
        stock: 'Estoque',
        startDate: 'Data de início',
        endDate: 'Data de finalização',
        status: 'Status',
        inProgress: 'em andamento',
        finished: 'finalizado',
        actions: 'Ações',
        continue: 'Continuar',
        verify: 'Conferir',
        delete: 'Excluir',
        deleteConfirmTitle: 'Excluir contagem',
        deleteConfirmMessage: 'Tem certeza que deseja excluir esta contagem? Esta ação não pode ser desfeita.',
        dateFrom: 'Data de',
        dateTo: 'Data até',
        allStocks: 'Todos os estoques',
        allStatuses: 'Todos',
        finalize: 'Finalizar contagem',
        finalizedSuccess: 'Contagem finalizada.',
        viewOnly: 'Contagem finalizada (somente leitura)',
        balance: 'Saldo',
        velocity: 'Velocidade (%/dia)',
        divergenceTitle: 'Divergência',
        divergenceMessage: 'Quantidade contada diferente do sistema. Deseja refazer a contagem?',
        keepCount: 'Não, registrar assim',
        refillCount: 'Sim, refazer',
        totalProducts: 'Produtos',
        productsCounted: 'Produtos contados',
        itemsCounted: 'Itens contados',
        countedAt: 'Data/hora da contagem',
        countedQtyLabel: 'Quantidade contada',
        systemQty: 'Qtd. sistema',
        unitValue: 'Valor unitário',
        notCounted: 'Não contado',
        counted: 'Contado',
        tapToCount: 'Toque para contar',
        tapToExpand: 'Toque para detalhes',
        pdvOfflineTitle: 'PDV offline',
        pdvOfflineMessage: 'Conecte o(s) PDV(s) vinculado(s) ao estoque antes de registrar.',
        connectPdv: 'Conectar PDV(s)',
        retryCheck: 'Verificar novamente',
        transferPendingTitle: 'Transferência pendente',
        transferPendingMessage: 'Finalize as transferências pendentes deste produto antes de registrar.',
        staleBanner: '{{count}} contagem(ns) em andamento há mais de {{days}} dias',
        showFilters: 'Filtros',
        hideFilters: 'Ocultar filtros',
        emptyTitle: 'Nenhuma contagem encontrada',
        emptyMessage: 'Crie uma nova contagem para começar o inventário.',
        sectionInProgress: 'Em andamento',
        sectionFinished: 'Finalizadas',
        started: 'Iniciada',
        productsProgress: '{{counted}} de {{total}} produtos',
        allProductsCounted: '{{total}} produtos contados',
        complete: 'Completa',
        today: 'Hoje',
        daysAgo_one: 'Há {{count}} dia',
        daysAgo_other: 'Há {{count}} dias',
        durationDays_one: '{{count}} dia',
        durationDays_other: '{{count}} dias',
        velocityShort: '{{value}}%/dia',
        storeClosed: 'Fechada',
        storeOpen: 'Aberta',
        countingBy: 'Contando: {{name}}',
        createdBy: 'Criada por {{name}}',
        finalizedBy: 'Finalizada por {{name}}',
        noPermission: 'Sem permissão para esta ação',
        deleteErrorTitle: 'Erro ao excluir',
        deleteErrorMessage: 'Não foi possível excluir a contagem.',
        finalizeConfirmMessage: 'Tem certeza que deseja finalizar esta contagem? Esta ação não pode ser desfeita.',
        finalizeErrorTitle: 'Erro ao finalizar',
        finalizeErrorMessage: 'Não foi possível finalizar a contagem.',
      },
      newCount: {
        title: 'Nova contagem',
        stockLabel: 'Estoque',
        structureLabel: 'Categoria',
        allCategories: 'Todas',
        selectedCount: '{{count}} selecionada(s)',
        valueToConsider: 'Valor a considerar',
        salesValue: 'Valor de venda',
        costValue: 'Valor de custo',
        storeModeLabel: 'Modalidade de contagem',
        storeModeClosed: 'Loja fechada',
        storeModeOpen: 'Loja aberta',
        storeModeHelpTitle: 'Modalidade de contagem',
        storeModeHelpBody: 'Loja Aberta: pode ser realizada ao longo de dias e sem a necessidade de parar a operação de venda e/ou movimentações de estoque. Melhor opção pra quem precisa fazer um balanço, mas não pode parar as vendas nem realizar contagem em horários fora de funcionamento.\n\nLoja Fechada: precisa ser realizada do início ao fim, o estoque não pode estar sendo movimentado, mas tem uma duração mais rápida e um nível de precisão um pouco mais elevado.',
        createErrorTitle: 'Erro ao criar',
        createErrorMessage: 'Não foi possível criar a contagem.',
      },
      pdvs: {
        title: 'PDVs',
        tabLabel: 'PDVs',
        subtitle: 'Pontos de Venda',
        online: 'Online',
        offline: 'Offline',
        allStocks: 'Todos os estoques',
        filterByStock: 'Filtrar por estoque',
        statusOnline: 'Conectado',
        statusOffline: 'Desconectado',
        lastPing: 'Último ping',
        noPing: 'Sem registro',
        address: 'Endereço',
        connect: 'Conectar',
        disconnect: 'Desconectar',
        linkedStock: 'Estoque vinculado',
        toggleError: 'Não foi possível alterar o status do PDV.',
        emptyTitle: 'Nenhum PDV cadastrado',
        emptyMessage: 'Os PDVs vinculados aos estoques aparecerão aqui.',
        summaryOnline: '{{count}} online',
        summaryOffline: '{{count}} offline',
        summaryTotal: '{{count}} PDV(s)',
      },
      settings: {
        title: 'Configurações',
        language: 'Idioma',
        theme: 'Aparência',
        themeSystem: 'Sistema',
        themeLight: 'Claro',
        themeDark: 'Escuro',
        account: 'Conta',
        role: 'Perfil',
        countProductSort: 'Ordem da lista na contagem',
        sortByName: 'Nome',
        sortByCode: 'Código',
        sortByValue: 'Valor',
        blindCount: 'Contagem às cegas',
        blindCountDescription: 'Oculta a quantidade do sistema durante a contagem',
        yes: 'Sim',
        no: 'Não',
        noPermission: 'Sem permissão para alterar esta configuração',
        profile: 'Perfil',
        preferences: 'Preferências',
        counting: 'Contagem',
        version: 'Versão {{version}}',
        devTools: 'Ferramentas de Desenvolvimento',
        devToolsDescription: 'Configurar o mock ERP para testes',
      },
      mockConfig: {
        title: 'Mock ERP',
        subtitle: 'Simula a API do CPlug para testar diferentes cenários de loja',
        storeSection: 'Loja',
        storeSize: 'Tamanho da loja',
        storeSizeDescription: 'Define a quantidade de estoques, PDVs, categorias e produtos',
        storeSizeSmall: 'Mercearia',
        storeSizeMedium: 'Mercado',
        storeSizeLarge: 'Supermercado',
        storeSummary: '{{stocks}} estoque(s) · {{pdvs}} PDV(s) · {{categories}} categorias · {{products}} produtos',
        networkSection: 'Rede',
        apiLatency: 'Latência da API',
        apiLatencyDescription: 'Simula atraso de rede nas chamadas da API',
        none: 'Nenhum',
        errorRate: 'Taxa de erros',
        errorRateDescription: 'Simula falhas aleatórias nas chamadas da API',
        never: 'Nunca',
        low: '20%',
        high: '50%',
        always: 'Sempre',
        dataSection: 'Dados da Contagem',
        productCount: 'Produtos por contagem',
        productCountDescription: 'Quantidade de produtos do catálogo incluídos em cada nova contagem',
        pdvScenario: 'Cenário dos PDVs',
        pdvScenarioDescription: 'Status padrão dos PDVs ao carregar',
        allOnline: 'Todos online',
        mixed: 'Misto',
        allOffline: 'Todos offline',
        previewSection: 'Dados Gerados',
        previewStocks: 'Estoques',
        previewPdvs: 'PDVs',
        previewCategories: 'Categorias',
        previewProducts: 'Produtos',
        previewMoreProducts: 'produtos a mais...',
        apiSection: 'Referência da API',
        apiDocsLink: 'Abrir documentação CPlug API',
        actionsSection: 'Ações',
        resetData: 'Resetar dados mock',
        resetDataDescription: 'Regenera estoques, PDVs, categorias e contagens baseado no tamanho da loja',
        resetConfirmTitle: 'Resetar dados?',
        resetConfirmMessage: 'Todos os dados de teste serão apagados e regenerados com base no tamanho de loja selecionado. Esta ação não pode ser desfeita.',
        resetSuccess: 'Dados resetados com sucesso',
        configSaved: 'Configuração salva',
        storeSizeChangeHint: 'Alterar o tamanho da loja requer resetar os dados',
      },
    },
  },
  en: {
    translation: {
      common: {
        ok: 'OK',
        cancel: 'Cancel',
        back: 'Back',
        create: 'Create',
        filter: 'Filter',
        logout: 'Log out',
      },
      home: {
        title: 'Home',
        tabLabel: 'Home',
        greetingMorning: 'Good morning',
        greetingAfternoon: 'Good afternoon',
        greetingEvening: 'Good evening',
        summary: 'Summary',
        activeCounts: 'Active',
        finishedCounts: 'Finished',
        totalProducts: 'Products',
        completionRate: 'Completion',
        quickActions: 'Quick actions',
        newCount: 'New count',
        viewCounts: 'View counts',
        recentActivity: 'Recent activity',
        noRecentActivity: 'No recent counts.',
        startCounting: 'Start by creating a new count.',
        continueCount: 'Continue',
        viewCount: 'View',
        count: 'Count',
        settings: 'Settings',
        teamActivity: 'Counting by user',
        activeCountsLabel_one: '{{count}} count',
        activeCountsLabel_other: '{{count}} counts',
        productsLabel: '{{counted}}/{{total}} products',
      },
      auth: {
        login: 'Log in',
        loginWithGoogle: 'Sign in with Google',
        selectUser: 'Select a profile to sign in',
        roleAdmin: 'Admin',
        roleManager: 'Manager',
        roleEmployee: 'Employee',
      },
      counts: {
        title: 'Counts',
        newCount: 'Open new count',
        code: 'Code',
        stock: 'Stock',
        startDate: 'Start date',
        endDate: 'End date',
        status: 'Status',
        inProgress: 'in progress',
        finished: 'finished',
        actions: 'Actions',
        continue: 'Continue',
        verify: 'Verify',
        delete: 'Delete',
        deleteConfirmTitle: 'Delete count',
        deleteConfirmMessage: 'Are you sure you want to delete this count? This action cannot be undone.',
        dateFrom: 'From date',
        dateTo: 'To date',
        allStocks: 'All stocks',
        allStatuses: 'All',
        finalize: 'Finalize count',
        finalizedSuccess: 'Count finalized.',
        viewOnly: 'Count finalized (read-only)',
        balance: 'Balance',
        velocity: 'Velocity (%/day)',
        divergenceTitle: 'Divergence',
        divergenceMessage: 'Counted quantity differs from system. Do you want to recount?',
        keepCount: 'No, register as is',
        refillCount: 'Yes, recount',
        totalProducts: 'Products',
        productsCounted: 'Products counted',
        itemsCounted: 'Items counted',
        countedAt: 'Count date/time',
        countedQtyLabel: 'Counted quantity',
        systemQty: 'System qty',
        unitValue: 'Unit value',
        notCounted: 'Not counted',
        counted: 'Counted',
        tapToCount: 'Tap to count',
        tapToExpand: 'Tap for details',
        pdvOfflineTitle: 'PDV offline',
        pdvOfflineMessage: 'Connect the PDV(s) linked to this stock before registering.',
        connectPdv: 'Connect PDV(s)',
        retryCheck: 'Retry check',
        transferPendingTitle: 'Pending transfer',
        transferPendingMessage: 'Complete pending transfers for this product before registering.',
        staleBanner: '{{count}} count(s) in progress for more than {{days}} days',
        showFilters: 'Filters',
        hideFilters: 'Hide filters',
        emptyTitle: 'No counts found',
        emptyMessage: 'Create a new count to start inventory.',
        sectionInProgress: 'In progress',
        sectionFinished: 'Finished',
        started: 'Started',
        productsProgress: '{{counted}} of {{total}} products',
        allProductsCounted: '{{total}} products counted',
        complete: 'Complete',
        today: 'Today',
        daysAgo_one: '{{count}} day ago',
        daysAgo_other: '{{count}} days ago',
        durationDays_one: '{{count}} day',
        durationDays_other: '{{count}} days',
        velocityShort: '{{value}}%/day',
        storeClosed: 'Closed',
        storeOpen: 'Open',
        countingBy: 'Counting: {{name}}',
        createdBy: 'Created by {{name}}',
        finalizedBy: 'Finalized by {{name}}',
        noPermission: 'No permission for this action',
        deleteErrorTitle: 'Delete error',
        deleteErrorMessage: 'Could not delete the count.',
        finalizeConfirmMessage: 'Are you sure you want to finalize this count? This action cannot be undone.',
        finalizeErrorTitle: 'Finalize error',
        finalizeErrorMessage: 'Could not finalize the count.',
      },
      newCount: {
        title: 'New count',
        stockLabel: 'Stock',
        structureLabel: 'Category',
        allCategories: 'All',
        selectedCount: '{{count}} selected',
        valueToConsider: 'Value to consider',
        salesValue: 'Sales value',
        costValue: 'Cost value',
        storeModeLabel: 'Counting mode',
        storeModeClosed: 'Store closed',
        storeModeOpen: 'Store open',
        storeModeHelpTitle: 'Counting mode',
        storeModeHelpBody: 'Store Open: can be performed over multiple days without the need to stop sales operations and/or stock movements. Best option for those who need to do inventory but cannot stop sales or count outside business hours.\n\nStore Closed: must be performed from start to finish, stock cannot be moving, but it has a faster duration and a slightly higher level of accuracy.',
        createErrorTitle: 'Create error',
        createErrorMessage: 'Could not create the count.',
      },
      pdvs: {
        title: 'PDVs',
        tabLabel: 'PDVs',
        subtitle: 'Points of Sale',
        online: 'Online',
        offline: 'Offline',
        allStocks: 'All stocks',
        filterByStock: 'Filter by stock',
        statusOnline: 'Connected',
        statusOffline: 'Disconnected',
        lastPing: 'Last ping',
        noPing: 'No record',
        address: 'Address',
        connect: 'Connect',
        disconnect: 'Disconnect',
        linkedStock: 'Linked stock',
        toggleError: 'Could not change the PDV status.',
        emptyTitle: 'No PDVs registered',
        emptyMessage: 'PDVs linked to stocks will appear here.',
        summaryOnline: '{{count}} online',
        summaryOffline: '{{count}} offline',
        summaryTotal: '{{count}} PDV(s)',
      },
      settings: {
        title: 'Settings',
        language: 'Language',
        theme: 'Appearance',
        themeSystem: 'System',
        themeLight: 'Light',
        themeDark: 'Dark',
        account: 'Account',
        role: 'Role',
        countProductSort: 'Product list order in count',
        sortByName: 'Name',
        sortByCode: 'Code',
        sortByValue: 'Value',
        blindCount: 'Blind count',
        blindCountDescription: 'Hides system quantity during counting',
        yes: 'Yes',
        no: 'No',
        noPermission: 'No permission to change this setting',
        profile: 'Profile',
        preferences: 'Preferences',
        counting: 'Counting',
        version: 'Version {{version}}',
        devTools: 'Developer Tools',
        devToolsDescription: 'Configure mock ERP for testing',
      },
      mockConfig: {
        title: 'Mock ERP',
        subtitle: 'Simulates the CPlug API to test different store scenarios',
        storeSection: 'Store',
        storeSize: 'Store size',
        storeSizeDescription: 'Defines the number of stocks, PDVs, categories, and products',
        storeSizeSmall: 'Small store',
        storeSizeMedium: 'Market',
        storeSizeLarge: 'Supermarket',
        storeSummary: '{{stocks}} stock(s) · {{pdvs}} PDV(s) · {{categories}} categories · {{products}} products',
        networkSection: 'Network',
        apiLatency: 'API Latency',
        apiLatencyDescription: 'Simulates network delay on API calls',
        none: 'None',
        errorRate: 'Error Rate',
        errorRateDescription: 'Simulates random failures on API calls',
        never: 'Never',
        low: '20%',
        high: '50%',
        always: 'Always',
        dataSection: 'Count Data',
        productCount: 'Products per count',
        productCountDescription: 'Number of catalog products included in each new inventory count',
        pdvScenario: 'PDV Scenario',
        pdvScenarioDescription: 'Default status for PDVs when loading',
        allOnline: 'All online',
        mixed: 'Mixed',
        allOffline: 'All offline',
        previewSection: 'Generated Data',
        previewStocks: 'Stocks',
        previewPdvs: 'PDVs',
        previewCategories: 'Categories',
        previewProducts: 'Products',
        previewMoreProducts: 'more products...',
        apiSection: 'API Reference',
        apiDocsLink: 'Open CPlug API documentation',
        actionsSection: 'Actions',
        resetData: 'Reset mock data',
        resetDataDescription: 'Regenerates stocks, PDVs, categories, and counts based on store size',
        resetConfirmTitle: 'Reset data?',
        resetConfirmMessage: 'All test data will be deleted and regenerated based on the selected store size. This action cannot be undone.',
        resetSuccess: 'Data reset successfully',
        configSaved: 'Configuration saved',
        storeSizeChangeHint: 'Changing store size requires a data reset',
      },
    },
  },
};

/**
 * Initialize i18n with PT and EN. Default language is PT; user can switch to EN in Settings.
 */
export function initI18n(): void {
  i18n.use(initReactI18next).init({
    resources,
    lng: DEFAULT_LOCALE,
    fallbackLng: DEFAULT_LOCALE,
    supportedLngs: ['pt', 'en'],
    interpolation: { escapeValue: false },
  });
}

export type SupportedLng = 'pt' | 'en';

/**
 * Read persisted language preference. Call after init to apply user choice.
 */
export async function getStoredLanguage(): Promise<SupportedLng | null> {
  try {
    const value = await SecureStore.getItemAsync(LANGUAGE_STORAGE_KEY);
    if (value === 'pt' || value === 'en') return value;
  } catch {
    // ignore
  }
  return null;
}

/**
 * Persist language preference and change i18n language.
 */
export async function setStoredLanguage(lng: SupportedLng): Promise<void> {
  try {
    await SecureStore.setItemAsync(LANGUAGE_STORAGE_KEY, lng);
    await i18n.changeLanguage(lng);
  } catch {
    i18n.changeLanguage(lng);
  }
}

export default i18n;
